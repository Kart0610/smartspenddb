<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SmartSpend â€” Dashboard</title>

  <!-- CSRF meta (Thymeleaf will inject token/header) -->
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}" />

  <!-- NEW: expose user id to client (only added this meta) -->
  <meta name="user-id" th:content="${user != null ? user.id : 0}" />

  <!-- NEW: also set a JS var window.userId using Thymeleaf (redundant but reliable) -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    // Expose user id to page JS. If user is null this becomes 0.
    window.userId = /*[[${user != null ? user.id : 0}]]*/ 0;
    /*]]>*/
  </script>

  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{ --bg-1:#081923; --bg-2:#0f2b38; --accent:#00e6e6; --card-bg:#0d2b36; --text-light:#d1d5db; --muted:#9aa6ad; --progress-bg:rgba(255,255,255,0.06); }
    html,body{margin:0;font-family:"Segoe UI", Roboto, system-ui, sans-serif;background:linear-gradient(to bottom right,var(--bg-1),var(--bg-2));color:var(--text-light);min-height:100vh}
    header{padding:1.25rem 2rem; display:flex; align-items:center; justify-content:space-between; background:rgba(0,30,40,0.6)}
    header h1{margin:0;color:var(--accent)}
    .header-right{display:flex; gap:1rem; align-items:center}
    .nav-btn{background:transparent;border:1px solid var(--accent); color:var(--accent); padding:0.45rem .85rem; border-radius:8px; text-decoration:none}
    main{padding:2.25rem 2rem}
    .overview-title{font-size:1.6rem; color:var(--accent); font-weight:700; margin-bottom:1rem; text-align:left}
    .cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:1rem; margin-bottom:1.75rem}
    .card{background:var(--card-bg); border-radius:12px; padding:1.25rem; box-shadow:0 6px 18px rgba(0,0,0,0.25)}
    .card h3{margin:0 0 .5rem 0; color:#bfeee8}
    .card .value{font-size:1.6rem; font-weight:700}
    .filters{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin:1.25rem 0; background:transparent}
    .filters input, .filters select{padding:.5rem .65rem; border-radius:8px; border:none; background:rgba(255,255,255,0.03); color:var(--text-light)}
    .filters label{display:block; font-size:.85rem; color:var(--muted); margin-bottom:.25rem}
    .filter-col{display:flex; flex-direction:column}
    .btn{padding:.6rem .9rem; border-radius:8px; border:none; cursor:pointer; font-weight:600}
    .btn-excel{background:#00bcd4; color:white}
    .btn-pdf{background:#e91e63; color:white}
    .table-card{background:var(--card-bg); border-radius:12px; padding:1rem; margin-top:1.5rem}
    table{width:100%; border-collapse:collapse; color:var(--text-light)}
    th,td{padding:.85rem 0; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left}
    th{color:var(--accent); font-weight:700}
    .right{display:flex; gap:.5rem; justify-content:flex-end; align-items:center}
    .small-muted{color:var(--muted); font-size:.9rem}
    /* budgets */
    .budget-item{display:flex; justify-content:space-between; gap:12px; padding:.75rem; background:rgba(255,255,255,0.02); border-radius:8px; margin-bottom:.6rem}
    .budget-progress{height:10px; background:var(--progress-bg); border-radius:6px; overflow:hidden}
    .budget-progress > i{display:block;height:100%; width:0%; background:linear-gradient(90deg,#00f0e0,#00bcd4)}
    .budget-progress > i.animate{transform:scaleX(1.03)}
    @media (max-width:820px){ .filters{justify-content:center} .cards{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))} }
  </style>
</head>

<body>
  <header>
    <h1>SmartSpend</h1>
    <div class="header-right">
      <span class="small-muted">Welcome, <strong th:text="${name}">User</strong></span>
      <a th:href="@{/dashboard}" class="nav-btn">Dashboard</a>
      <a th:href="@{/expenses}" class="nav-btn">Expenses</a>
      <a th:href="@{/incomes}" class="nav-btn">Incomes</a>
      <a th:href="@{/logout}" class="nav-btn">Logout</a>
    </div>
  </header>

  <main>
    <!-- 1) Overview cards -->
    <div class="overview-title">Overview</div>
    <div class="cards">
      <div class="card">
        <h3>Total Expenses</h3>
        <div class="value" th:text="${totalStr}">0.00</div>
        <div class="small-muted">Sum of displayed expense transactions</div>
      </div>

      <div class="card">
        <h3>Highest Expense</h3>
        <div class="value" th:text="${highestStr}">0.00</div>
        <div class="small-muted">Largest expense</div>
      </div>

      <div class="card">
        <h3>Average Expense</h3>
        <div class="value" th:text="${averageStr}">0.00</div>
        <div class="small-muted">Average per expense</div>
      </div>

      <div class="card">
        <h3>Categories</h3>
        <div class="value" th:text="${categoriesCount}">0</div>
        <div class="small-muted">Distinct categories</div>
      </div>
    </div>

    <!-- 2) Filters (for history only) -->
    <form id="filterForm" class="filters" onsubmit="return false;">
      <div class="filter-col">
        <label for="startDate">From</label>
        <input type="date" id="startDate" name="startDate" />
      </div>

      <div class="filter-col">
        <label for="endDate">To</label>
        <input type="date" id="endDate" name="endDate" />
      </div>

      <div class="filter-col">
        <label for="category">Category</label>
        <input type="text" id="category" name="category" placeholder="Category" />
      </div>

      <div class="filter-col">
        <label for="minAmount">Min Amount</label>
        <input type="number" id="minAmount" name="minAmount" placeholder="0" />
      </div>

      <div class="filter-col">
        <label for="maxAmount">Max Amount</label>
        <input type="number" id="maxAmount" name="maxAmount" placeholder="10000" />
      </div>

      <div class="filter-col">
        <label for="sort">Sort</label>
        <select id="sort" name="sort">
          <option value="date_desc">Date (newest)</option>
          <option value="date_asc">Date (oldest)</option>
          <option value="amount_desc">Amount (largest)</option>
          <option value="amount_asc">Amount (smallest)</option>
        </select>
      </div>

      <div class="right" style="margin-left:auto;">
        <button type="button" class="btn" onclick="applyFilters()">Apply</button>
        <button type="button" class="btn" onclick="resetFilters()">Reset</button>
      </div>
    </form>

    <!-- 3) Transactions table (history) - moved above chart & budgets -->
    <div class="table-card">
      <h3 style="margin-top:0;">Expense History</h3>
      <table id="expenseTable">
        <thead>
          <tr>
            <th>Title</th>
            <th>Category</th>
            <th>Amount</th>
            <th>Type</th>
            <th>Date</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody>
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>

    <!-- 4) Chart (LEFT) and Budgets (RIGHT) - side-by-side -->
    <div style="display:flex; gap:18px; align-items:flex-start; margin-top:14px; flex-wrap:wrap;">
      <!-- Chart area -->
      <div style="flex:1; min-width:320px; background:var(--card-bg); padding:12px; border-radius:10px;">
        <h3 style="margin:0 0 8px 0; color:var(--accent)">Expense Summary</h3>
        <canvas id="expenseChart" height="200"></canvas>
      </div>

      <!-- Budgets + downloads -->
      <div style="min-width:320px; display:flex; flex-direction:column; gap:12px;">
        <div style="background:var(--card-bg); padding:12px; border-radius:10px;">
          <h3 style="margin:0 0 8px 0; color:var(--accent)">Manage Budgets</h3>

          <form id="budgetForm" onsubmit="return false;" style="display:flex; gap:8px; align-items:center; margin-bottom:12px;">
            <input id="budgetCategory" placeholder="Category" style="flex:1; padding:.5rem; border-radius:8px;" />
            <input id="budgetLimit" placeholder="Limit Amount" type="number" style="width:120px; padding:.5rem; border-radius:8px;" />
            <button id="addBudgetBtn" type="button" class="btn" style="background:transparent; border:1px solid var(--accent); color:var(--accent)">Add Budget</button>
          </form>

          <div id="budgetList"></div>
        </div>

        <div style="display:flex; gap:8px; align-items:center;">
          <a id="downloadExcel" class="btn btn-excel" href="/api/reports/excel" title="Download Excel">ðŸ“Š Download Excel</a>
          <a id="downloadPdf" class="btn btn-pdf" href="/api/reports/pdf" title="Download PDF">ðŸ“„ Download PDF</a>
        </div>
      </div>
    </div>
  </main>

  <footer style="padding:1rem 2rem; text-align:center; background:rgba(0,0,0,0.15); color:var(--muted)">Â© 2025 SmartSpend â€” Track smarter, save better.</footer>

  <!-- Dashboard script: fetches filtered data for table and unfiltered data for chart -->
  <script>
    const API_BASE = window.location.origin;
    const EXPENSES_API = '/api/expenses';
    const EXCEL_API = '/api/reports/excel';
    const PDF_API = '/api/reports/pdf';
    const BUDGETS_API = '/api/budgets';

    let expenseChart = null;

    // format helpers
    const fmtAmount = (n) => (n == null) ? '0.00' : Number(n).toFixed(2);
    const fmtDate = (s) => s ? String(s).slice(0,10) : '';

    function buildQuery() {
      const from = document.getElementById('startDate').value;
      const to   = document.getElementById('endDate').value;
      const category = document.getElementById('category').value;
      const minAmount = document.getElementById('minAmount').value;
      const maxAmount = document.getElementById('maxAmount').value;
      const sort = document.getElementById('sort').value;

      const params = new URLSearchParams();
      if (from) params.set('from', from);
      if (to) params.set('to', to);
      if (category && category.trim() !== '') params.set('category', category.trim());
      if (minAmount !== '' && !isNaN(Number(minAmount))) params.set('minAmount', Number(minAmount));
      if (maxAmount !== '' && !isNaN(Number(maxAmount))) params.set('maxAmount', Number(maxAmount));
      if (sort) params.set('sort', sort);
      const q = params.toString();
      return q ? ('?' + q) : '';
    }

    function updateDownloadLinks() {
      const q = buildQuery();
      const excelAnchor = document.getElementById('downloadExcel');
      const pdfAnchor = document.getElementById('downloadPdf');
      if (excelAnchor) excelAnchor.href = EXCEL_API + q;
      if (pdfAnchor) pdfAnchor.href = PDF_API + q;
    }

    /**
     * fetchAndRender:
     *  - GET filtered list (with query) -> used for the table (history)
     *  - GET unfiltered list (no query) -> used only for chart (pictorial summary)
     */
    async function fetchAndRender() {
      try {
        updateDownloadLinks();
        const q = buildQuery();

        // 1) filtered rows for the table
        let tableData = [];
        try {
          const tableResp = await fetch(EXPENSES_API + q, { credentials: 'include' });
          if (!tableResp.ok) {
            console.error('Failed to fetch filtered expenses for table', tableResp.status);
            renderTable([]);
          } else {
            const rows = await tableResp.json();
            tableData = (rows || []).map(e => ({ ...e, amount: e.amount == null ? 0 : Number(e.amount), date: e.date ? String(e.date).slice(0,10) : '' }));
            renderTable(tableData);
          }
        } catch (errTable) {
          console.error('Error fetching filtered table data', errTable);
          renderTable([]);
        }

        // 2) unfiltered rows for the chart (always show all expenses)
        try {
          const chartResp = await fetch(EXPENSES_API, { credentials: 'include' }); // no query params
          if (!chartResp.ok) {
            console.error('Failed to fetch expenses for chart', chartResp.status);
            renderChart([]);
          } else {
            const allRows = await chartResp.json();
            const chartData = (allRows || []).map(e => ({ ...e, amount: e.amount == null ? 0 : Number(e.amount), date: e.date ? String(e.date).slice(0,10) : '' }));
            renderChart(chartData);
          }
        } catch (errChart) {
          console.error('Error fetching chart data', errChart);
          renderChart([]);
        }
      } catch (err) {
        console.error('Unexpected error in fetchAndRender:', err);
        renderTable([]);
        renderChart([]);
      }
    }

    function applyFilters() { fetchAndRender(); }
    function resetFilters(){
      document.getElementById('filterForm').reset();
      const s = document.getElementById('sort'); if (s) s.value = 'date_desc';
      fetchAndRender();
    }

    function renderTable(data) {
      const tbody = document.querySelector('#expenseTable tbody');
      if (!tbody) return;
      if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No transactions found</td></tr>';
        return;
      }
      tbody.innerHTML = data.map(e => `
        <tr>
          <td>${e.title || ''}</td>
          <td>${e.category || ''}</td>
          <td>${fmtAmount(e.amount)}</td>
          <td>${e.type || ''}</td>
          <td>${fmtDate(e.date)}</td>
          <td>${e.description || ''}</td>
        </tr>
      `).join('');
    }

    function renderChart(data) {
      const ctx = document.getElementById('expenseChart').getContext('2d');
      const totals = {};
      (data || []).forEach(e => {
        const cat = e.category || 'Uncategorized';
        totals[cat] = (totals[cat] || 0) + (Number(e.amount) || 0);
      });
      const labels = Object.keys(totals);
      const values = Object.values(totals);

      if (expenseChart) {
        try { expenseChart.destroy(); } catch(_) {}
        expenseChart = null;
      }
      expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: { labels, datasets: [{ data: values }] },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom', labels: { color:'#d1d5db' } } }
        }
      });
    }

    // Budgets (CSRF-aware + improved error reporting)
    async function loadBudgets() {
      try {
        const res = await fetch(BUDGETS_API, { credentials: 'include' });
        if (!res.ok) {
          let body = '';
          try { body = await res.text(); } catch(_) {}
          console.error('Failed to load budgets', res.status, body);
          document.getElementById('budgetList').innerHTML = '<p class="small-muted">Could not load budgets.</p>';
          return;
        }
        const raw = await res.json();
        const safeNumber = v => {
          if (v === null || v === undefined) return 0;
          if (typeof v === 'number') return v;
          if (typeof v === 'string') { const n = parseFloat(v.replace(/,/g,'')); return isNaN(n) ? 0 : n; }
          if (typeof v === 'object') { if (v.value !== undefined) return safeNumber(v.value); if (v.amount !== undefined) return safeNumber(v.amount); try { const n = Number(v); return isNaN(n) ? 0 : n; } catch(_) { return 0; } }
          return 0;
        };
        const normalized = (raw || []).map(b => ({ id: b.id ?? null, category: b.category ?? '', limitAmount: safeNumber(b.limitAmount), spentAmount: safeNumber(b.spentAmount) }));
        if (!normalized.length) { document.getElementById('budgetList').innerHTML = '<p class="small-muted">No budgets yet.</p>'; return; }
        const html = normalized.map(b=>{
          const pct = (b.limitAmount && b.limitAmount>0) ? Math.min(100, Math.round((b.spentAmount||0)/b.limitAmount*100)) : 0;
          return `<div class="budget-item"><div><strong>${escapeHtml(b.category)}</strong><div class="small-muted">Spent â‚¹${(b.spentAmount||0).toFixed(2)} / â‚¹${(b.limitAmount||0).toFixed(2)}</div><div class="budget-progress"><i style="width:0%"></i></div></div><div class="small-muted" style="min-width:46px;text-align:right">${pct}%</div></div>`;
        }).join('');
        const listEl = document.getElementById('budgetList'); listEl.innerHTML = html;
        normalized.forEach((b, idx) => {
          const item = listEl.querySelectorAll('.budget-item')[idx];
          if (!item) return;
          const bar = item.querySelector('.budget-progress > i');
          if (!bar) return;
          const pct = (b.limitAmount && b.limitAmount>0) ? Math.min(100, Math.round((b.spentAmount||0)/b.limitAmount*100)) : 0;
          setTimeout(()=>{ requestAnimationFrame(()=>{ bar.style.width = pct + '%'; bar.classList.add('animate'); setTimeout(()=>bar.classList.remove('animate'),350); }); }, Math.min(300, idx * 60));
        });
      } catch (e) { console.error('Error loading budgets', e); document.getElementById('budgetList').innerHTML = '<p class="small-muted">Could not load budgets.</p>'; }
    }

    async function addBudget() {
      const catEl = document.getElementById('budgetCategory'), limitEl = document.getElementById('budgetLimit'), addBtn = document.getElementById('addBudgetBtn');
      const category = (catEl.value || '').trim(); const limitVal = (limitEl.value || '').trim();
      if (!category) { alert('Please enter a category'); return; }
      const parsedLimit = limitVal === '' ? null : Number(limitVal);
      if (parsedLimit === null || isNaN(parsedLimit) || parsedLimit <= 0) { alert('Please enter a valid budget limit'); return; }
      addBtn.disabled = true;
      try {
        const payload = { category: category, limitAmount: parsedLimit };

        // CSRF retrieval (Thymeleaf meta tags) - fallback to cookie named XSRF-TOKEN
        const csrfTokenMeta = document.querySelector('meta[name="_csrf"]');
        const csrfHeaderMeta = document.querySelector('meta[name="_csrf_header"]');
        const headers = { 'Content-Type': 'application/json' };
        if (csrfTokenMeta && csrfHeaderMeta) {
          headers[csrfHeaderMeta.content] = csrfTokenMeta.content;
        } else {
          const match = document.cookie.match(new RegExp('(^| )XSRF-TOKEN=([^;]+)'));
          if (match) headers['X-XSRF-TOKEN'] = decodeURIComponent(match[2]);
        }

        const res = await fetch(BUDGETS_API, { method:'POST', credentials:'include', headers, body: JSON.stringify(payload) });

        if (!res.ok) {
          let txt = '';
          try { txt = await res.text(); } catch(_) {}
          console.error('Failed to add budget', res.status, txt);
          alert('Failed to add budget: ' + (txt || res.status));
          return;
        }

        catEl.value=''; limitEl.value=''; await loadBudgets(); alert('Budget added!');
      } catch (e) { console.error('Error adding budget', e); alert('Failed to add budget'); } finally { addBtn.disabled = false; }
    }

    function escapeHtml(s) { return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    // init
    document.addEventListener('DOMContentLoaded', function(){
      document.getElementById('addBudgetBtn').addEventListener('click', addBudget);
      document.getElementById('startDate').addEventListener('change', updateDownloadLinks);
      document.getElementById('endDate').addEventListener('change', updateDownloadLinks);
      document.getElementById('sort').addEventListener('change', updateDownloadLinks);

      const applyBtn = document.querySelector('#filterForm button[onclick="applyFilters()"]');
      const resetBtn = document.querySelector('#filterForm button[onclick="resetFilters()"]');
      if (applyBtn) applyBtn.addEventListener('click', applyFilters);
      if (resetBtn) resetBtn.addEventListener('click', resetFilters);

      // initial fetches
      fetchAndRender();
      loadBudgets();
    });
  </script>

  <!-- START: WebSocket real-time notification client (ADDED) -->
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

  <script>
    (function(){
      // read the user id produced by the server (meta tag) or fallback to window.userId
      const userIdMeta = document.querySelector('meta[name="user-id"]');
      const userIdFromMeta = userIdMeta ? Number(userIdMeta.content || 0) : 0;
      // window.userId is set earlier by Thymeleaf script block; prefer that if present
      const userId = (typeof window.userId === 'number' && window.userId > 0) ? window.userId : userIdFromMeta;

      console.debug('PAGE userId (quick check):', userId);

      if (!userId || userId === 0) {
        console.debug('WS: no userId â€” skipping notifications subscription.');
        return;
      }

      try {
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);
        // optional: reduce console noise in production
        stompClient.debug = function() { /* no-op to quiet stomp debug */ };

        stompClient.connect({}, function(frame) {
          console.debug('[STOMP] connected:', frame && frame.headers ? frame.headers['user-name'] || frame.headers['user-name'] : frame);
          // Subscribe to broad topic and user-specific topic (matches server convertAndSend)
          stompClient.subscribe('/topic/notifications', function(message){
            // message.body may be plain text or JSON
            let payloadText = message.body;
            try {
              const parsed = JSON.parse(message.body);
              payloadText = (parsed.title ? parsed.title + ': ' : '') + (parsed.body || JSON.stringify(parsed));
            } catch(e) {
              // not JSON, use raw body
            }
            console.debug('[WS] topic notification:', payloadText);
          });

          stompClient.subscribe('/topic/notifications/' + userId, function(message){
            // message.body may be JSON (recommended) or plain text
            let payloadDisplay = message.body;
            try {
              const parsed = JSON.parse(message.body);
              // show title + body if present
              if (parsed.title || parsed.body) {
                payloadDisplay = (parsed.title ? parsed.title + ': ' : '') + (parsed.body || '');
              } else {
                payloadDisplay = JSON.stringify(parsed);
              }
            } catch(e) {
              // non-JSON payload -> use body string
              payloadDisplay = message.body;
            }

            // small toast
            try {
              const toast = document.createElement('div');
              toast.textContent = payloadDisplay;
              toast.style.position = 'fixed';
              toast.style.right = '16px';
              toast.style.bottom = '16px';
              toast.style.background = 'rgba(0,0,0,0.85)';
              toast.style.color = '#fff';
              toast.style.padding = '10px 14px';
              toast.style.borderRadius = '8px';
              toast.style.boxShadow = '0 6px 18px rgba(0,0,0,0.3)';
              toast.style.zIndex = 99999;
              toast.style.fontSize = '14px';
              document.body.appendChild(toast);
              setTimeout(()=> toast.remove(), 4500);
            } catch(e) {
              try { alert('ðŸ”” ' + payloadDisplay); } catch(_) { console.log('Notification:', payloadDisplay); }
            }
          });
        }, function(err){
          console.warn('WS connection error', err);
        });
      } catch (e) {
        console.error('Failed to initialize WebSocket client', e);
      }
    })();
  </script>
  <!-- END: WebSocket real-time notification client -->

</body>
</html>









